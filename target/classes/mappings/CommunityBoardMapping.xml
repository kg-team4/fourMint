<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="CommunityBoardDAO">

	<resultMap type="communityBoard" id="communityResult">
		<result property="community_seq" column="COMMUNITY_SEQ"/>
		<result property="title" column="TITLE" />
		<result property="category" column="CATEGORY" />
		<result property="date" column="DATE" />
		<result property="nickname" column="NICKNAME" />
		<result property="address2" column="ADDRESS2" />
		<result property="content" column="CONTENT"/>
		<result property="url" column="URL"/>
		<result property="views" column="VIEWS"/>
		<result property="likes" column="LIKES"/>
	</resultMap>
	
	<select id="getCommunityBoardList" resultType="communityBoard" parameterType="int">
		<![CDATA[SELECT * FROM (SELECT (row_number() over()) AS rnum, * FROM (SELECT * FROM communityBoard ORDER BY date DESC) AS a) AS b WHERE rnum >= #{startRow} AND rnum <= #{endRow}]]> 
	</select>
	
	<select id="getBoardCount" resultType="int">
		SELECT count(userName) FROM communityBoard
	</select>
	
	<insert id="insertCommunity" parameterType="four.mint.web.user.community.CommunityBoardVO">
		INSERT INTO community(community_seq, title, category, nickname, address2, content, url)
		VALUES(DEFAULT, #{title}, #{category}, #{nickname}, #{address2}, #{content}, #{url})
	</insert>
	
	<select id="getKindList" resultType="communityBoard" parameterType="string">
		SELECT * FROM community WHERE category = #{kind}
	</select>
	
	<select id="getBoard" resultType="communityBoard" parameterType="int">
		SELECT * FROM community WHERE community_seq = #{seq}
	</select>
	
	<select id="getCommunityListMe" resultType="communityBoard" parameterType="string">
		SELECT * FROM community WHERE nickname = #{nickname}
	</select>
	
	<update id="updateViews" parameterType="int">
		UPDATE community SET views = views + 1 WHERE community_seq = #{seq}
	</update>
	
	<update id="updateComments" parameterType="int">
		UPDATE community SET comments = comments + 1 WHERE community_seq = #{board_seq}
	</update>
	
	<resultMap type="communityComment" id="commentResult">
		<result property="comment_seq" column="COMMENT_SEQ"/>
		<result property="nickname" column="NICKNAME" />
		<result property="date" column="TIMESTAMP" />
		<result property="content" column="CONTENT"/>
		<result property="board_seq" column="BOARD_SEQ"/>
		<result property="re_seq" column="RE_SEQ"/>
		<result property="title" column="TITLE"/>
	</resultMap>
	
	<insert id="insertComment" parameterType="four.mint.web.user.community.CommunityCommentVO">
		INSERT INTO communityComment(nickname, content, board_seq) VALUES(#{nickname}, #{content}, #{board_seq}) 
	</insert>
	
	<select id="getCommunityComment" resultType="communityComment" parameterType="int">
		SELECT * FROM (SELECT b.profile, c.* FROM (SELECT profile, nickname FROM member) as b JOIN (SELECT * FROM communitycomment) as c ON b.nickname = c.nickname) as d WHERE board_seq = #{community_seq};
	</select>
	
	<select id="getCommentList" resultType="communityComment" parameterType="string">
		select a.*, b.title from (select * from communityComment WHERE nickname = #{nickname}) AS a JOIN (select title, community_seq from community) AS b ON a.board_seq = b.community_seq;
	</select>
	
</mapper>